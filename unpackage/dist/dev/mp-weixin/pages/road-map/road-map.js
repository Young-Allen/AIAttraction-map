(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/road-map/road-map"],{62:function(t,n,e){"use strict";(function(t,n){var o=e(4);e(26);o(e(25));var i=o(e(63));t.__webpack_require_UNI_MP_PLUGIN__=e,n(i.default)}).call(this,e(1)["default"],e(2)["createPage"])},63:function(t,n,e){"use strict";e.r(n);var o=e(64),i=e(66);for(var a in i)["default"].indexOf(a)<0&&function(t){e.d(n,t,(function(){return i[t]}))}(a);e(71);var s,r=e(32),c=Object(r["default"])(i["default"],o["render"],o["staticRenderFns"],!1,null,null,null,!1,o["components"],s);c.options.__file="pages/road-map/road-map.vue",n["default"]=c.exports},64:function(t,n,e){"use strict";e.r(n);var o=e(65);e.d(n,"render",(function(){return o["render"]})),e.d(n,"staticRenderFns",(function(){return o["staticRenderFns"]})),e.d(n,"recyclableRender",(function(){return o["recyclableRender"]})),e.d(n,"components",(function(){return o["components"]}))},65:function(t,n,e){"use strict";var o;e.r(n),e.d(n,"render",(function(){return i})),e.d(n,"staticRenderFns",(function(){return s})),e.d(n,"recyclableRender",(function(){return a})),e.d(n,"components",(function(){return o}));try{o={lTabs:function(){return e.e("uni_modules/l-tabs/components/l-tabs/l-tabs").then(e.bind(null,233))},uniNoticeBar:function(){return e.e("uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar").then(e.bind(null,240))},uniFab:function(){return e.e("uni_modules/uni-fab/components/uni-fab/uni-fab").then(e.bind(null,247))},uniPopup:function(){return e.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(e.bind(null,254))},uniSteps:function(){return e.e("uni_modules/uni-steps/components/uni-steps/uni-steps").then(e.bind(null,261))},movableSwiper:function(){return e.e("components/movable-swiper/movable-swiper").then(e.bind(null,268))},uniIcons:function(){return Promise.all([e.e("common/vendor"),e.e("uni_modules/uni-icons/components/uni-icons/uni-icons")]).then(e.bind(null,275))},zqsSelect:function(){return e.e("components/zqs-select/zqs-select").then(e.bind(null,283))},cmdProgress:function(){return e.e("components/cmd-progress/cmd-progress").then(e.bind(null,292))},uniPopupDialog:function(){return Promise.all([e.e("common/vendor"),e.e("uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog")]).then(e.bind(null,299))},uniRate:function(){return e.e("uni_modules/uni-rate/components/uni-rate/uni-rate").then(e.bind(null,311))}}}catch(r){if(-1===r.message.indexOf("Cannot find module")||-1===r.message.indexOf(".vue"))throw r;console.error(r.message),console.error("1. 排查组件名称拼写是否正确"),console.error("2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom"),console.error("3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件")}var i=function(){var t=this,n=t.$createElement,e=(t._self._c,t.polyline.length),o=0!==e&&""!==t.spendTime&&null!=t.spendTime?t._f("formatTime")(t.spendTime):null,i=0!==e?t.threeRoadOne.length:null;t.$mp.data=Object.assign({},{$root:{g0:e,f0:o,g1:i}})},a=!1,s=[];i._withStripped=!0},66:function(t,n,e){"use strict";e.r(n);var o=e(67),i=e.n(o);for(var a in o)["default"].indexOf(a)<0&&function(t){e.d(n,t,(function(){return o[t]}))}(a);n["default"]=i.a},67:function(t,n,e){"use strict";(function(t,o){var i=e(4);Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var a=i(e(47)),s=i(e(18)),r=i(e(49)),c=i(e(11)),d=(e(68),e(34)),u=i(e(51)),l=i(e(46)),p=i(e(69));function f(t,n){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),e.push.apply(e,o)}return e}function m(t){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?f(Object(e),!0).forEach((function(n){(0,c.default)(t,n,e[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):f(Object(e)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}))}return t}var h="../../static/place_icons/place02.png",g="../../static/place_icons/locPosition.png",v=function(){e.e("components/map_tabbar/map_tabbar").then(function(){return resolve(e(318))}.bind(null,e)).catch(e.oe)},y=function(){e.e("components/movable-swiper/movable-swiper").then(function(){return resolve(e(268))}.bind(null,e)).catch(e.oe)},P=function(){e.e("components/xiao-star-component/xiao-star-component").then(function(){return resolve(e(325))}.bind(null,e)).catch(e.oe)},b=function(){e.e("components/zqs-select/zqs-select").then(function(){return resolve(e(283))}.bind(null,e)).catch(e.oe)},R=function(){e.e("components/hm-sms-list-card/index").then(function(){return resolve(e(332))}.bind(null,e)).catch(e.oe)},w=function(){e.e("components/cmd-progress/cmd-progress").then(function(){return resolve(e(292))}.bind(null,e)).catch(e.oe)},C=e(70),L=new C({key:"K7JBZ-VCBHQ-ET554-4CBVM-YLCXT-MGFNJ"}),T={components:{midTabbar:v,movableSwiper:y,xiaoStarComponent:P,zqsSelect:b,HmSmsListCard:R,cmdProgress:w},computed:m(m(m({},(0,d.mapState)("m_settings",["headNavi","isShowModal","GroundOverlay"])),(0,d.mapState)("m_roadMsg",["activePoint","roadList",,"allPointList","pointList","road"])),(0,d.mapState)("m_user",["userPosition","token","userinfo"])),watch:{activePoint:function(t,n){this.moveToLocation(this.threeRoadOne[t])}},filters:{formatTime:function(t){return t.toFixed(2)}},data:function(){return{pointCrowds:50,isGetLocation:!1,isShowRoadContent:!1,getCrowdsTimer:null,_mapContext:"",polyline:[],staticRoad:{roadList:[]},staticRoadPolyline:[],dynamicPoint:[],dynamicRoad:[],dynamicRoadPolyline:[],dynamicSpendTime:"",vipRoad:[],vipRoadPolyline:[],vipRoadSpendTime:"",threeRoadOne:[],spendTime:"",position:{},notice:"",options:{},recommendations:[],checkPointList:[],sortCheckPointList:[],wantToGoList:[],dynamicCrowds:[],scanPoint:{id:"",name:"",score:5},roadContent:[{iconPath:"/static/my-icons/default.png",selectedIconPath:"/static/my-icons/default-select.png",text:"默认线路",active:!1},{iconPath:"/static/my-icons/dynamic.png",selectedIconPath:"/static/my-icons/dynamic-select.png",text:"动态线路",active:!1},{iconPath:"/static/my-icons/vip-road.png",selectedIconPath:"/static/my-icons/vip-road-select.png",text:"精品线路",active:!1}]}},onReady:function(){var n=this;return(0,r.default)(a.default.mark((function e(){var o,i;return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return o=n,n._mapContext.initMarkerCluster({enableDefaultStyle:!1,zoomOnClick:!0,gridSize:20}),n.setMapBoundary(),e.next=5,p.default.getDynamicAttractionInfo();case 5:i=e.sent,n.dynamicCrowds=i.data,n.addMarkers(n.allPointList),n.addGroundOverlay(),n.pageTabL(),n._mapContext.setLocMarkerIcon({iconPath:"../../static/place_icons/locPosition.png"}),""!==n.userPosition&&(n.addUserMarker(n.userPosition),n.moveToLocation(n.userPosition)),t.connectSocket({url:"wss://www.expiredcanned.love/contact/"+n.userinfo.id,header:{authorization:n.token},success:function(t){console.log(t)}}),t.onSocketMessage((function(t){console.log("收到服务器内容："+t.data),o.notice=JSON.parse(t.data).content})),setInterval((function(){t.sendSocketMessage({data:""})}),3e4);case 15:case"end":return e.stop()}}),e)})))()},onLoad:function(n){var e=this;if(this._mapContext=t.createMapContext("map",this),"true"===n.showStaticRoad?(this.polyline=[],this.getStaticRoad(n.staticRoadId)):n.showStaticRoad,n.gotoPosition){var o=JSON.parse(decodeURIComponent(n.pos));this.moveToLocation(o)}p.default.getAttractionList(1,50).then((function(t){e.updateAllPoints(t.data[0])})),this.getCrowdsTimer=setInterval((function(){p.default.getDynamicAttractionInfo().then((function(t){e.dynamicCrowds=t.data,console.log(t)}))}),3e5)},onUnload:function(){t.onSocketClose((function(t){console.log("WebSocket 已关闭！")})),clearInterval(this.getCrowdsTimer),this.getCrowdsTimer=null},methods:m(m(m(m({},(0,d.mapMutations)("m_roadMsg",["saveActivePointToStorage","updateActivePoint","updatePointList","updateAllPoints"])),(0,d.mapMutations)("m_settings",["updateIsShowModal","updateRoadContent"])),(0,d.mapMutations)("m_user",["saveUserPositionToStorage","updateUserPosition"])),{},{gotoPos:function(t){var n=this;return(0,r.default)(a.default.mark((function e(){var o,i,s,r,c;return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return o=n,console.log(t),console.log(n.userPosition),e.next=5,u.default.pathToSingleSource(n.userPosition.longitude,n.userPosition.latitude,t);case 5:for(i=e.sent,s=i.data,console.log(s),n.dynamicSpendTime=s.totalCost,n.spendTime=s.totalCost,n.polyline=[],n.dynamicRoad=[],n.dynamicRoad.push(n.userPosition),s.viaNodeIds.forEach((function(t){var e=n.allPointList.find((function(n){return n.id===t}));n.dynamicRoad.push(e)})),n.roadContent.forEach((function(t){return t.active=!1})),n.roadContent[1].active=!0,r=function(){var t={},e={};e="三叠泉"===n.dynamicRoad[c].name||0==c&&"三叠泉"===n.dynamicRoad[c+1].name?{longitude:"116.024443",latitude:"29.560302"}:{longitude:n.dynamicRoad[c].longitude,latitude:n.dynamicRoad[c].latitude},t="三叠泉"===n.dynamicRoad[c+1].name?{longitude:"116.024443",latitude:"29.560302"}:{longitude:n.dynamicRoad[c+1].longitude,latitude:n.dynamicRoad[c+1].latitude},setTimeout((function(){o.addPointPolyline(e,t)}),1e4*(c/4-1))},c=0;c<n.dynamicRoad.length-1;c++)r();n.dynamicRoad.shift(),n.dynamicRoadPolyline=n.polyline,n.threeRoadOne=n.dynamicRoad,n.$refs.popupHi.close(),n.$refs.roadMsg.open();case 23:case"end":return e.stop()}}),e)})))()},chooseTab:function(t){if("景点"===t.item)this.addMarkers(this.allPointList);else{var n=this.allPointList.filter((function(n){return n.category===t.item}));this.addMarkers(n)}},getStaticRoad:function(t){var n=this;this.spendTime="";var e=this;u.default.getStaticRoadById(t).then((function(t){console.log(t),n.staticRoad=t.data,n.threeRoadOne=t.data.roadList,n.roadContent.forEach((function(t){return t.active=!1})),n.roadContent[0].active=!0,n.$refs.roadMsg.open();for(var o=function(t){var o={},i={};o="三叠泉"===n.staticRoad.roadList[t+1].name?{longitude:"116.024443",latitude:"29.560302"}:{longitude:n.staticRoad.roadList[t+1].longitude,latitude:n.staticRoad.roadList[t+1].latitude},i="三叠泉"===n.staticRoad.roadList[t].name?{longitude:"116.024443",latitude:"29.560302"}:{longitude:n.staticRoad.roadList[t].longitude,latitude:n.staticRoad.roadList[t].latitude},setTimeout((function(){e.addPointPolyline(i,o)}),1e4*(t/4-1))},i=0;i<n.staticRoad.roadList.length-1;i++)o(i);n.staticRoadPolyline=n.polyline}))},addPointPolyline:function(t,n){var e=this;L.direction({mode:"walking",from:t,to:n,success:function(t){console.log(t.result.routes[0]);for(var n=t.result.routes[0].polyline,o=[],i=2;i<n.length;i++)n[i]=Number(n[i-2])+Number(n[i])/1e6;for(i=0;i<n.length;i+=2)o.push({latitude:n[i],longitude:n[i+1]});e.addPolyline(o)}})},addPolyline:function(t){this.polyline.push({points:t,color:"#47a6ff",width:7,arrowLine:!0,borderWidth:1})},dialogInputConfirm:function(t){console.log(this.scanPoint),p.default.addNewScore(this.scanPoint.id,this.scanPoint.score).then((function(t){console.log(t)})),this.$refs.inputDialog.close()},dialogClose:function(){this.dialogInputConfirm()},scanBtn:function(){var n=this;t.scanCode({success:function(e){try{var o=JSON.parse(e.result);n.scanPoint=o,console.log(n.scanPoint),n.$refs.inputDialog.open()}catch(i){t.showToast({title:"数据获取失败！",duration:2e3})}}})},moveToLocation:function(t){console.log(t),this._mapContext.moveToLocation({longitude:parseFloat(t.longitude),latitude:parseFloat(t.latitude)})},toPointDetail:function(n){t.navigateTo({url:"/subpkg/sub_pointDetail/sub_pointDetail?id="+n})},clickCard:function(n){console.log(n),t.navigateTo({url:"/subpkg/sub_pointDetail/sub_pointDetail"})},selectChange2:function(){},selectPoint:function(n){var e=this;if(console.log(n),1===n.length)return t.showToast({icon:"none",title:"再选一个景点吧！",duration:2e3});this.sortCheckPointList=[],n.forEach((function(t){var n={},o=e.allPointList.find((function(n){return n.id===t}));n.name=o.name,n.id=o.id,n.location={lat:o.latitude,lng:o.longitude},e.sortCheckPointList.push(n)})),this.getDistance(this.sortCheckPointList)},getDistance:function(t){var n=this;return(0,r.default)(a.default.mark((function e(){var o;return a.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return o=n,e.next=3,L.calculateDistance({from:n.userPosition,to:t,success:function(){var t=(0,r.default)(a.default.mark((function t(n){var e,i,s,r,c,d;return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e=n.result.elements,e.forEach((function(t,n){o.sortCheckPointList[n].dis=t.distance})),o.sortCheckPointList.sort((function(t,n){return t.dis-n.dis})),console.log(o.sortCheckPointList),i=[],o.sortCheckPointList.forEach((function(t){i.push(t.id)})),t.next=8,u.default.getVipRoad(i);case 8:for(s=t.sent,r=s.data,console.log(r),o.spendTime=r.totalCost,o.vipRoadSpendTime=r.totalCost,o.vipRoad=[],o.polyline=[],r.viaNodeIds.forEach((function(t){var n=o.allPointList.find((function(n){return n.id===t}));o.vipRoad.push(n)})),o.roadContent.forEach((function(t){return t.active=!1})),o.roadContent[2].active=!0,o.threeRoadOne=o.vipRoad,o.$refs.roadMsg.open(),c=function(){var t={},n={};t="三叠泉"===o.vipRoad[d+1].name?{longitude:"116.024443",latitude:"29.560302"}:{longitude:o.vipRoad[d+1].longitude,latitude:o.vipRoad[d+1].latitude},n="三叠泉"===o.vipRoad[d].name?{longitude:"116.024443",latitude:"29.560302"}:{longitude:o.vipRoad[d].longitude,latitude:o.vipRoad[d].latitude},setTimeout((function(){o.addPointPolyline(n,t)}),1e4*(d/4-1))},d=0;d<o.vipRoad.length-1;d++)c();console.log(o.vipRoad),o.vipRoadPolyline=o.polyline;case 24:case"end":return t.stop()}}),t)})));function n(n){return t.apply(this,arguments)}return n}()});case 3:n.threeRoadOne=n.vipRoad,n.$refs.roadMsg.open();case 5:case"end":return e.stop()}}),e)})))()},searchEvent:function(t){var n=this;this.wantToGoList=[],p.default.getAttractionByName(t,1,50).then((function(t){n.wantToGoList=[].concat((0,s.default)(n.wantToGoList),(0,s.default)(t.data[0]))}))},switchSpot:function(t){this.updateActivePoint(t)},change:function(){this.activePoint<this.pointList.length-1?this.activePoint+=1:this.activePoint=0},trigger:function(t){this.updateActivePoint(0),0===t.index?(this.spendTime="",this.polyline=this.staticRoadPolyline,this.threeRoadOne=this.staticRoad.roadList):1===t.index?(this.spendTime=this.dynamicSpendTime,this.polyline=this.dynamicRoadPolyline,this.threeRoadOne=this.dynamicRoad):2===t.index&&(this.spendTime=this.vipRoadSpendTime,this.polyline=this.vipRoadPolyline,this.threeRoadOne=this.vipRoad),console.log(this.threeRoadOne),!1===this.roadContent[t.index].active&&(this.roadContent.forEach((function(t){t.active=!1})),this.roadContent[t.index].active=!t.item.active),this.$refs.roadMsg.open(),this.$refs.fab.changeHide()},pageTabL:function(){var n=this;t.getFuzzyLocation({success:function(e){var i={latitude:e.latitude,longitude:e.longitude};o.request({url:"https://apis.map.qq.com/ws/geocoder/v1/?location=".concat(i.latitude,",").concat(i.longitude,"&key=K7JBZ-VCBHQ-ET554-4CBVM-YLCXT-MGFNJ"),success:function(e){var o=e.data.result.address_component.city;o.includes("庐山市")?(n.position=i,n.updateUserPosition(n.position),this.addUserMarker(n.position),console.log("当前位置在庐山市内")):(n.isGetLocation=!0,t.showToast({title:"您当前的位置不在景区内请点击地图设置当前位置",duration:4e3,icon:"none"}))}})}})},tapMap:function(t){this.viewshow=!1,console.log("点击返回经纬度:",t.detail),this.isGetLocation&&(this.position=t.detail,this.updateUserPosition(this.position),this.addUserMarker(this.position),this.isGetLocation=!1)},pageTabML:function(){t.navigateTo({url:"/subpkg/sub_addToGroup/sub_addToGroup"})},pageTabMM:function(){t.navigateTo({url:"/subpkg/sub_message/sub_message"})},pageTabMR:function(){var t=this;return(0,r.default)(a.default.mark((function n(){return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return t.wantToGoList=t.allPointList,n.next=3,l.default.getRecommendation();case 3:t.recommendations=n.sent,t.recommendations.forEach((function(n,e){t.$set(t.recommendations[e],"checked",!1)})),t.updateIsShowModal("true");case 6:case"end":return n.stop()}}),n)})))()},addUserMarker:function(t){this._mapContext.removeMarkers({markerIds:[999],success:function(t){console.log(t)}}),this._mapContext.addMarkers({markers:[{id:999,latitude:t.latitude,longitude:t.longitude,iconPath:g,width:30,height:30,anchor:{x:.5,y:.5}}],clear:!1,complete:function(t){console.log("addMarkers",t)}})},addMarkers:function(t){var n=this;console.log(t);var e=[];t.forEach((function(t,o){var i=n.dynamicCrowds.find((function(n){return n.attractionId===t.id}));e.push({id:t.id,title:t.name,latitude:t.latitude,longitude:t.longitude,joinCluster:!0,iconPath:h,width:25,height:25,anchor:{x:.5,y:.5},callout:{content:t.name,color:i.current/i.capacity>.85?"#ffffff":"#666",borderRadius:5,bgColor:i.current/i.capacity>.85?"#e43d33":"#ffffff",padding:5,textAlign:"center",display:"ALWAYS"}})})),this._mapContext.addMarkers({markers:e,clear:!0,complete:function(t){console.log("addMarkers",t)}})},addGroundOverlay:function(){var t=this;this.GroundOverlay.forEach((function(n){t._mapContext.addGroundOverlay(n)}))},markertap:function(t){if(999!==t.detail.markerId){var n=this.allPointList.find((function(n){return n.id===t.detail.markerId}));console.log(n);var e=this.dynamicCrowds.find((function(t){return t.attractionId===n.id}));this.options={id:n.id,primary:n.imgsUrl,openNote:n.openNote,paybak:n.name,score:n.score,capacity:e.capacity,current:e.current,txt:"详情",side:"/static/hm-sms-list-card/images/img_25832_0_0.png"},this.$refs.popupHi.open()}},setMapBoundary:function(){var t={longitude:115.879179,latitude:29.493921},n={longitude:116.055004,latitude:29.57655},e=this;this._mapContext.setBoundary({southwest:t,northeast:n,success:function(o){e._mapContext.moveToLocation({latitude:(t.latitude+n.latitude)/2,longitude:(t.longitude+n.longitude)/2,scale:10})}})}})};n.default=T}).call(this,e(2)["default"],e(1)["default"])},71:function(t,n,e){"use strict";e.r(n);var o=e(72),i=e.n(o);for(var a in o)["default"].indexOf(a)<0&&function(t){e.d(n,t,(function(){return o[t]}))}(a);n["default"]=i.a},72:function(t,n,e){}},[[62,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/road-map/road-map.js.map